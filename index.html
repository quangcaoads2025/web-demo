<!-- N√∫t b·∫≠t popup -->
<div class="popup-toggle-btn" id="qcadsGiftBtn">üéÅ</div>

<style>
  /* ===== N√öT üéÅ ===== */
  .popup-toggle-btn {
    position: fixed;
    bottom: 10%;
    left: 0;
    background-color: #d60000;
    color: white;
    font-size: 22px;
    padding: 10px 14px;
    border-radius: 0 10px 10px 0;
    cursor: pointer;
    z-index: 100000;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    pointer-events: auto;
  }

  /* ===== L·ªöP N·ªÄN POPUP ===== */
  .popup-widget * { box-sizing: border-box; }
  .popup-widget {
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.3);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: Arial, sans-serif;
    pointer-events: auto;
  }

  /* ===== H·ªòP POPUP CH√çNH ===== */
  .popup-form {
    background: #ffffff;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    max-width: 920px;
    width: 100%;
    position: relative;
    overflow: hidden;
    pointer-events: auto;
  }

  /* ·∫¢NH N·ªÄN CH√åM CH·ªà B√äN TR√ÅI */
  .popup-form::before{ content:none !important; }

  .qcads-left{ position: relative; }
  .qcads-left::before{
    content:"";
    position:absolute;
    inset:0;
    background: url('https://www.ngocanhcm.vn/data/category/thongtinweb.png') no-repeat left center;
    background-size: 115%;
    opacity: 0.12;
    z-index: 0;
    pointer-events: none;
  }
  .qcads-left > *{ position: relative; z-index: 1; }

  /* ===== LAYOUT 2 C·ªòT ===== */
  .qcads-popup-grid{
    display: flex;
    gap: 20px;
    align-items: stretch;
  }
  .qcads-left{
    flex: 1 1 56%;
    min-width: 0;

    display: flex;
    flex-direction: column;
    min-height: 560px;
  }
  .qcads-right{
    flex: 1 1 44%;
    min-width: 0;
    border-left: 1px solid rgba(0,0,0,0.08);
    padding-left: 18px;
  }

  /* ===== TI√äU ƒê·ªÄ + M√î T·∫¢ ===== */
  .popup-form h2, .popup-form p {
    text-align: center;
    font-weight: 700;
  }
  .popup-form h2 { font-size: 18px; color: #222; margin: 0 0 8px; }
  .popup-form p { font-size: 14px; color: #d62828; margin: 0 0 16px; }

  /* ===== INPUT ===== */
  .popup-form input[type="text"], .popup-form input[type="email"] {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: transparent;
    color: #000;
    font-size: 15px;
    font-weight: 500;
  }
  .popup-form input::placeholder { color: #111; opacity: 1; }
  .popup-form input[type="checkbox"] { margin-right: 6px; }
  .popup-form label {
    font-size: 12px;
    display: flex;
    align-items: center;
    margin-top: 6px;
  }

  /* ===== N√öT SUBMIT ===== */
  .popup-form button {
    background: red;
    color: white;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }

  /* H√†ng n√∫t: tr√°i ‚Äì ph·∫£i */
  .popup-form .form-actions{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: 10px;
  }
  .popup-form .form-actions #submitBtn{ margin-top: 0; }
  .popup-form .form-actions .dismiss-link{
    margin-left: 0;
    color: blue;
    text-decoration: underline;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    white-space: nowrap;
  }

  /* ===== N√öT ƒê√ìNG ===== */
  .close-btn {
    position: absolute;
    top: 12px; right: 16px;
    cursor: pointer;
    font-size: 22px;
    color: #666;
    z-index: 10;
    pointer-events: auto;
  }

  /* ===== SUCCESS ===== */
  #successMessage {
    display: none;
    text-align: left;
    margin-top: 20px;
    line-height: 1.5;
    font-size: 16px;
  }
  #successMessage h3 {
    color: green;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    text-align: center;
  }
  #successMessage p { margin: 6px 0; }
  #successMessage span#couponCode,
  #successMessage span#wonValue {
    color: red;
    font-size: 18px;
    font-weight: bold;
  }

  /* ===== FOOTER ===== */
  .site-footer {
    text-align: center;
    font-size: 12px;
    color: #777;
    padding: 10px 8px;
    border-top: 1px solid #ddd;
    margin-top: auto;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(2px);
  }
  .site-footer strong { color: #111; }

  /* ===== GIFT TEXT ===== */
  .gift-text {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    color: red;
    line-height: 1.4;
    margin: 6px 0 10px 0;
  }

  /* ===== V√íNG QUAY ===== */
  #wheelContainer { display: none; margin-top: 10px; text-align: center; }
  #wheel {
    border-radius: 50%;
    display: block;
    margin: 0 auto;
    border: 6px solid #fff;
    box-shadow: 0 0 25px rgba(255,255,255,0.4), inset 0 0 35px rgba(255,255,255,0.2);
    transition: transform 5s cubic-bezier(.23,1,.32,1);
  }
  .wheel-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
  }
  .arrow {
    position: absolute;
    top: -20px; left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-bottom: 26px solid #ffde59;
    filter: drop-shadow(0 0 6px #fff);
    z-index: 15;
  }
  .center-button {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90px; height: 90px;
    border-radius: 50%;
    background: linear-gradient(145deg, #ff007a, #ffde59);
    border: 4px solid white;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 0 20px #ff007a, 0 0 40px #ffde59, inset 0 0 10px rgba(255,255,255,.5);
    user-select: none; z-index: 10;
    transition: all .3s ease;
  }
  .center-button:hover {
    transform: translate(-50%, -50%) scale(1.05);
    box-shadow: 0 0 25px #ffde59, 0 0 55px #ff007a;
  }
  .center-button span { color: white; font-weight: bold; font-size: 14px; }
  .center-button .pointer {
    position: absolute; top: 4px; left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 15px solid #fff;
    filter: drop-shadow(0 0 4px #fff);
  }
  #result {
    margin-top: 12px;
    font-size: 18px;
    font-weight: bold;
    color: #2c3e50;
    min-height: 28px;
  }

  /* ===== C·ªòT PH·∫¢I ===== */
  .qcads-right-card{
    background: rgba(255,255,255,0.75);
    border-radius: 12px;
    padding: 14px 14px 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }
  .qcads-hotline{
    display:flex;
    align-items:center;
    justify-content:center;
    margin-bottom: 10px;
  }
  .qcads-hotline .qcads-pill{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding: 10px 12px;
    border-radius: 999px;
    background: #ffffff;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 6px 16px rgba(0,0,0,0.07);
    font-weight: 800;
  }
  .qcads-hotline .qcads-pill .qcads-icon{
    width: 30px; height: 30px;
    border-radius: 50%;
    background: #1b5cff;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 16px;
  }
  .qcads-hotline .qcads-pill .qcads-text{
    line-height: 1.1;
    text-align: left;
    font-size: 12px;
    font-weight: 800;
    color:#1a1a1a;
  }
  .qcads-hotline .qcads-pill .qcads-text b{
    display:block;
    font-size: 16px;
    letter-spacing: .3px;
    color:#0a2a7a;
  }
  .qcads-right ul{
    list-style: none;
    margin: 10px 0 14px;
    padding: 0;
  }
  .qcads-right li{
    margin: 8px 0;
    font-size: 15px;
    font-weight: 700;
    color:#222;
    display:flex;
    gap:8px;
    align-items:flex-start;
  }
  .qcads-right li .dot{
    width: 18px;
    flex: 0 0 18px;
    line-height: 1.2;
  }

  .qcads-logo{ display:block; padding: 14px 0 8px; }
  .qcads-logo .logo-box{
    width: 100%;
    height: 180px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: transparent;
    border: none;
    padding: 0;
  }
  .qcads-logo .logo-box img{
    display:block;
    max-width:100%;
    max-height:100%;
    width:auto;
    height:auto;
    object-fit:contain;
  }

  .qcads-right-hot{
    position: relative;
    margin-top: 14px;
    padding: 14px 12px;
    border-radius: 14px;
    text-align: center;
    font-weight: 900;
    font-size: 13.5px;
    line-height: 1.5;
    color: #d60000;
    background: linear-gradient(135deg,#fff5f5,#ffffff,#fff5f5);
    border: 1px dashed rgba(214,0,0,.55);
    box-shadow: 0 8px 22px rgba(214,0,0,.18), inset 0 0 0 1px rgba(214,0,0,.15);
    overflow: hidden;
  }
  .qcads-right-hot::before{
    content: "üî•HOTüî•";
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    letter-spacing: 1px;
    animation: qcadsHotBlink 1.4s infinite;
  }
  .qcads-right-hot::after{
    content:"";
    position:absolute;
    top:0;
    left:-70%;
    width:60%;
    height:100%;
    background: linear-gradient(120deg,transparent,rgba(255,255,255,0.75),transparent);
    animation: qcadsHotShine 3s infinite;
  }
  @keyframes qcadsHotBlink{ 0%,100%{opacity:1} 50%{opacity:.55} }
  @keyframes qcadsHotShine{ 0%{left:-70%} 100%{left:120%} }

  /* HI·ªÜU ·ª®NG QU√Ä üéÅ */
  .qcads-right li .dot{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width: 22px;
    height: 22px;
    border-radius: 8px;
    background: rgba(214,0,0,0.08);
    box-shadow: 0 0 0 rgba(214,0,0,0);
    animation: qcadsGiftPulse 1.2s infinite;
  }
  .qcads-right li:nth-child(2) .dot{ animation-delay: .15s; }
  .qcads-right li:nth-child(3) .dot{ animation-delay: .30s; }
  .qcads-right li:nth-child(4) .dot{ animation-delay: .45s; }
  .qcads-right li:nth-child(5) .dot{ animation-delay: .60s; }
  @keyframes qcadsGiftPulse{
    0%{transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(214,0,0,0)}
    40%{transform:translateY(-1px) scale(1.08); box-shadow:0 10px 18px rgba(214,0,0,.15)}
    70%{transform:translateY(0) scale(1.02)}
    100%{transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(214,0,0,0)}
  }

  /* Mobile: ·∫©n c·ªôt ph·∫£i */
  @media (max-width: 768px){
    .popup-form{ max-width: 92%; padding: 16px; }
    .qcads-popup-grid{ display:block; }
    .qcads-right{ display:none; }
  }

  /* ===== TH√îNG B√ÅO CUSTOM (THAY alert) ===== */
  #qcadsAlert{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200000;
  }
  .qcads-alert-box{
    background: #fff;
    border-radius: 14px;
    padding: 18px 16px 14px;
    max-width: 420px;
    width: 92%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,.25);
  }
  .qcads-alert-box h3{
    margin: 0 0 8px;
    font-size: 18px;
    font-weight: 900;
    color: #d60000;
  }
  .qcads-alert-box p{
    margin: 0;
    font-size: 14px;
    line-height: 1.5;
    color: #222;
  }
  .qcads-alert-box button{
    margin-top: 12px;
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    background: #d60000;
    color: #fff;
    font-weight: 800;
    cursor: pointer;
  }
</style>

<!-- Popup ch√≠nh -->
<div class="popup-widget" id="qcadsPopup">
  <div class="popup-form">
    <span class="close-btn" title="ƒê√≥ng" tabindex="0">√ó</span>

    <div class="qcads-popup-grid">

      <!-- C·ªòT TR√ÅI -->
      <div class="qcads-left">
        <h2>üî•GIAO DI·ªÜN N√ÇNG C·∫§Püî•<br>N√ÇNG T·∫¶M TR·∫¢I NGH·ªÜM QU√ù KH√ÅCH H√ÄNG</h2>
        <p>XE NG·ªåC ANH ‚Äì UY T√çN - CH·∫§T L∆Ø·ª¢NG - GI√Å T·ªêT</p>

        <form id="registerForm">
          <input type="text" name="name" placeholder="T√™n c·ªßa Anh/Ch·ªã:*" required />
          <input type="text" name="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i:*" required />
          <input type="text" name="address" placeholder="ƒê·ªãa ch·ªâ li√™n h·ªá:*" required />
          <input type="text" name="car" placeholder="D√≤ng xe quan t√¢m:*" required />
          <input type="text" name="note" placeholder="Y√™u c·∫ßu kh√°c (n·∫øu c√≥):" />
          <label><input type="checkbox" required /> T√¥i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n c·ªßa Xe Ng·ªçc Anh</label>

          <div class="form-actions">
            <button type="submit" id="submitBtn">ƒêƒÇNG K√ù NGAY</button>
            <a class="dismiss-link" tabindex="0">B·ªØa kh√°c nha!</a>
          </div>
        </form>

        <!-- V√≤ng quay -->
        <div id="wheelContainer">
          <div class="wheel-container">
            <div class="arrow"></div>
            <canvas id="wheel" width="300" height="300"></canvas>
            <div class="center-button" id="spinBtn" tabindex="0">
              <div class="pointer"></div>
              <span>Quay</span>
            </div>
          </div>
          <div id="result"></div>
        </div>

        <div id="successMessage">
          <h3>üéâC·∫¢M ∆†N Anh/Ch·ªã <span id="showName"></span><br>ƒê√É THAM GIA CH∆Ø∆†NG TR√åNHüòò</h3>
          <p>M√É QU√Ä T·∫∂NG L√Ä: <span id="couponCode"></span></p>
          <div id="wonValue" class="gift-text"></div>
          <p>VUI L√íNG CH·ª§P M√ÄN H√åNH HO·∫∂C ƒê·ªåC T√äN KHI NH·∫¨N QU√Ä T·∫∂NG.</p>
          <p>üîî ‚ÄúVoucher gi·∫£m gi√° kh√¥ng quy ƒë·ªïi th√†nh ti·ªÅn m·∫∑t v√† ch·ªâ √°p d·ª•ng 01 m√£ khi mua xe. M√£ gi·∫£m gi√° ƒë∆∞·ª£c QuangCaoAds l∆∞u ƒë·ªÉ ƒë·ªëi chi·∫øu khi thanh to√°n.‚Äù</p>
        </div>

        <div class="site-footer">
          ¬© 2025 B·∫£n quy·ªÅn thu·ªôc v·ªÅ <strong>QuangCaoAds</strong> | Thi·∫øt k·∫ø b·ªüi<br><strong>MKT HLAds - Xe Ng·ªçc Anh C√† Mau</strong>
        </div>
      </div>

      <!-- C·ªòT PH·∫¢I -->
      <div class="qcads-right">
        <div class="qcads-right-card">
          <div class="qcads-hotline">
            <div class="qcads-pill">
              <div class="qcads-icon">‚òé</div>
              <div class="qcads-text">
                HOTLINE
                <b>08888 58 200</b>
              </div>
            </div>
          </div>

          <ul>
            <li><span class="dot">üöÄ</span><span>XE NG·ªåC ANH ‚Äì CH√çNH H√ÉNG, GI√Å T·ªêT</span></li>
            <li><span class="dot">üéÅ</span><span>Mua xe chu·∫©n ‚Äì Gi√° t·ªët</span></li>
            <li><span class="dot">üéÅ</span><span>Giao t·∫≠n nh√† to√†n t·ªânh</span></li>
            <li><span class="dot">üéÅ</span><span>Qu√† t·∫∑ng h·∫•p d·∫´n ‚Äì Tr·∫£ g√≥p duy·ªát nhanh</span></li>
            <li><span class="dot">üéÅ</span><span>Ng·ªçc Anh Th∆∞∆°ng hi·ªáu uy t√≠nh 30 nƒÉm</span></li>
          </ul>

          <!-- LOGO (kh√¥ng khung) -->
          <div class="qcads-logo">
            <div class="logo-box">
              <img src="https://bydthanhcong.vn/wp-content/uploads/2025/12/NGOC-ANH-LOGO-01-2048x1600.png" alt="Xe Ng·ªçc Anh Logo">
            </div>
          </div>

          <div class="qcads-right-hot">
            H√£y ƒë·ªÉ l·∫°i th√¥ng tin, nh·∫≠n ngay ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i!
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- TH√îNG B√ÅO CUSTOM (thay alert) -->
<div id="qcadsAlert">
  <div class="qcads-alert-box">
    <h3>üéÅ Th√¥ng b√°o</h3>
    <p id="qcadsAlertText"></p>
    <button type="button" id="qcadsAlertOk">ƒê√£ hi·ªÉu</button>
  </div>
</div>

<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script type="text/javascript">
/* ===== TH√îNG B√ÅO CUSTOM ===== */
function qcadsShowAlert(text){
  var box = document.getElementById('qcadsAlert');
  var t = document.getElementById('qcadsAlertText');
  if (!box || !t) return;
  t.innerText = text || '';
  box.style.display = 'flex';
}
function qcadsCloseAlert(){
  var box = document.getElementById('qcadsAlert');
  if (!box) return;
  box.style.display = 'none';
}

(function(){
  var ok = document.getElementById('qcadsAlertOk');
  if (ok) ok.addEventListener('click', qcadsCloseAlert);
})();

/* ====== POPUP OPEN/CLOSE ====== */
window.showPopup = function () {
  var popup = document.getElementById('qcadsPopup') || document.querySelector('.popup-widget');
  if (!popup) return;
  popup.style.display = 'flex';

  if (typeof confetti !== 'undefined') {
    confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
    setTimeout(function () {
      confetti({ particleCount: 100, spread: 80, origin: { y: 0.6 } });
    }, 500);
  }
};

window.qcadsHidePopup = function () {
  var popup = document.getElementById('qcadsPopup') || document.querySelector('.popup-widget');
  if (!popup) return;
  popup.style.display = 'none';
};

/* ====== LOGIC V√íNG QUAY / KHO QU√Ä ====== */
var canvas = document.getElementById("wheel");
var ctx = canvas.getContext("2d");
var size = canvas.width;
var center = size / 2;

var segments = [
  "B·ªò 06 LY<br>TH·ª¶Y TINH<br>CAO C·∫§P",
  "VALI<br>CAO C·∫§P<br>YAMAHA",
  "TAI NGHE<br>AIRPOOD 4",
  "VOUCHER<br>3.000.000ƒê",
  "VOUCHER<br>5.000.000ƒê"
];
var colors = [
 ["#0099ff","#0059b3"],
 ["#00c2ff","#007ca3"],
 ["#00ffcc","#00b386"],
 ["#ffde59","#c4a000"],
 ["#ff5ebc","#c7007a"]
];

var arc = (2 * Math.PI) / segments.length;
var spinAngle = 0, spinning = false;

var PRIZE_STOCK_KEY = "qcads_prize_stock_v1";

function qcadsInitStockIfNeeded() {
  var raw = localStorage.getItem(PRIZE_STOCK_KEY);
  if (raw) return;
  var stock = { "0": 27, "1": 3, "2": 1 };
  localStorage.setItem(PRIZE_STOCK_KEY, JSON.stringify(stock));
}

function qcadsGetStock() {
  qcadsInitStockIfNeeded();
  try { return JSON.parse(localStorage.getItem(PRIZE_STOCK_KEY) || "{}"); }
  catch (e) { return {}; }
}

function qcadsSaveStock(stock) {
  localStorage.setItem(PRIZE_STOCK_KEY, JSON.stringify(stock));
}

function qcadsPickPrizeIndexByStock(stock) {
  var total = 0;
  for (var k in stock) {
    if (!stock.hasOwnProperty(k)) continue;
    var n = parseInt(stock[k], 10) || 0;
    if (n > 0) total += n;
  }
  if (total <= 0) return null;

  var r = Math.floor(Math.random() * total);
  var acc = 0;

  for (var kk in stock) {
    if (!stock.hasOwnProperty(kk)) continue;
    var nn = parseInt(stock[kk], 10) || 0;
    if (nn <= 0) continue;
    acc += nn;
    if (r < acc) return parseInt(kk, 10);
  }
  return null;
}

function drawWheel() {
  for (var i = 0; i < segments.length; i++) {
    var angle = i * arc;
    var grad = ctx.createLinearGradient(0, 0, size, size);
    grad.addColorStop(0, colors[i][0]);
    grad.addColorStop(1, colors[i][1]);
    ctx.fillStyle = grad;

    ctx.beginPath();
    ctx.moveTo(center, center);
    ctx.arc(center, center, center, angle, angle + arc, false);
    ctx.fill();

    ctx.save();
    ctx.translate(center, center);
    ctx.rotate(angle + arc / 2);
    ctx.fillStyle = "white";
    ctx.font = "bold 16px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    var lines = segments[i].split("<br>");
    var lineHeight = 18;
    var textRadius = center - 45;

    for (var j = 0; j < lines.length; j++) {
      var lineY = (j - (lines.length - 1) / 2) * lineHeight;
      ctx.fillText(lines[j].trim(), textRadius, lineY);
    }
    ctx.restore();
  }
}
drawWheel();

function spin() {
  if (spinning) return;
  spinning = true;

  var stock = qcadsGetStock();
  var selectedIndex = qcadsPickPrizeIndexByStock(stock);

  if (selectedIndex === null) {
    spinning = false;
    qcadsShowAlert("Ch∆∞∆°ng tr√¨nh ƒë√£ h·∫øt qu√† t·∫∑ng d√†nh cho qu√Ω kh√°ch h√†ng. C·∫£m ∆°n anh/ch·ªã ƒë√£ mua h√†ng v√† s·ª≠ d·ª•ng d·ªãch v·ª•.");
    return;
  }

  stock[String(selectedIndex)] = (parseInt(stock[String(selectedIndex)], 10) || 0) - 1;
  if (stock[String(selectedIndex)] < 0) stock[String(selectedIndex)] = 0;
  qcadsSaveStock(stock);

  var segmentDegree = 360 / segments.length;
  var segmentCenterDegree = selectedIndex * segmentDegree + segmentDegree / 2;
  var spins = Math.floor(Math.random() * 4 + 4);
  var finalDegree = spins * 360 + (360 + 270 - segmentCenterDegree) % 360;
  var finalRad = finalDegree * Math.PI / 180;
  var duration = 4000;
  var start = null;

  function rotateWheel(timestamp) {
    if (!start) start = timestamp;
    var progress = timestamp - start;
    var easing = 1 - Math.pow(1 - progress / duration, 3);
    spinAngle = finalRad * easing;

    ctx.clearRect(0, 0, size, size);
    ctx.save();
    ctx.translate(center, center);
    ctx.rotate(spinAngle);
    ctx.translate(-center, -center);
    drawWheel();
    ctx.restore();

    if (progress < duration) {
      requestAnimationFrame(rotateWheel);
    } else {
      window.pendingSegment = segments[selectedIndex];

      var history = JSON.parse(localStorage.getItem("spinHistory") || "{}");
      var phone = document.getElementById('registerForm').elements['phone'].value.trim();
      if (!history[phone]) history[phone] = {};
      if (!history[phone].firstPrize) history[phone].firstPrize = window.pendingSegment;
      else if (!history[phone].secondPrize) history[phone].secondPrize = window.pendingSegment;

      localStorage.setItem("spinHistory", JSON.stringify(history));

      document.getElementById("result").innerText = "üéâ B·∫°n tr√∫ng: " + window.pendingSegment;
      spinning = false;
      window.showSuccessAfterSpin();
    }
  }
  requestAnimationFrame(rotateWheel);
}

/* ====== BOOT ====== */
function qcadsBoot() {
  var closeBtn = document.querySelector('.popup-form .close-btn');
  var dismissLink = document.querySelector('.popup-form .dismiss-link');
  var form = document.getElementById('registerForm');
  var wheelContainer = document.getElementById('wheelContainer');
  var spinBtn = document.getElementById('spinBtn');
  var giftBtn = document.getElementById('qcadsGiftBtn');

  qcadsInitStockIfNeeded();

  if (giftBtn) {
    giftBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      window.showPopup();
    }, true);
  }

  function hidePopup(){ window.qcadsHidePopup(); }
  if (closeBtn) closeBtn.addEventListener('click', hidePopup);
  if (dismissLink) dismissLink.addEventListener('click', function (e) {
    e.preventDefault();
    hidePopup();
  });

  function isPhoneValid(phone){ return /^0\d{9}$/.test(phone); }

  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      var name = form.elements['name'].value.trim();
      var phone = form.elements['phone'].value.trim();
      var address = form.elements['address'].value.trim();
      var car = form.elements['car'].value.trim();
      var note = form.elements['note'].value.trim();

      if (!isPhoneValid(phone)) {
        qcadsShowAlert('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (ph·∫£i c√≥ 10 s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0).');
        form.elements['phone'].focus();
        return;
      }

      var couponCode = 'NA' + Math.floor(100000 + Math.random() * 900000);
      window.pendingUserName = name;
      window.pendingCouponCode = couponCode;

      var history = JSON.parse(localStorage.getItem("spinHistory") || "{}");
      history[phone] = { lastCoupon: couponCode };
      localStorage.setItem("spinHistory", JSON.stringify(history));

      form.style.display = 'none';
      wheelContainer.style.display = 'block';
      document.getElementById('result').innerText = '';
    });
  }

  window.showSuccessAfterSpin = function () {
    var successMessage = document.getElementById('successMessage');
    wheelContainer.style.display = 'none';
    successMessage.style.display = 'block';

    document.getElementById('showName').innerText = window.pendingUserName || '';
    document.getElementById('couponCode').innerText = window.pendingCouponCode || '';
    document.getElementById('wonValue').innerHTML = (window.pendingSegment || '').replace(/<br\s*\/?>/gi, ' ');

    var formData = new FormData();
    formData.append('entry.2068377047', window.pendingUserName);

    var phoneInput = document.querySelector('input[name="phone"]');
    var addressInput = document.querySelector('input[name="address"]');
    var carInput = document.querySelector('[name="car"]');
    var noteInput = document.querySelector('input[name="note"]');

    formData.append('entry.1431142738', phoneInput ? phoneInput.value.trim() : '');
    formData.append('entry.450626231', addressInput ? addressInput.value.trim() : '');
    formData.append('entry.188096586', carInput ? carInput.value.trim() : '');
    formData.append('entry.350180116', noteInput ? noteInput.value.trim() : '');
    formData.append('entry.147650368', window.pendingCouponCode);
    formData.append('entry.1042830072', (window.pendingSegment || '').replace(/<br\s*\/?>/gi, ' '));

    fetch("https://docs.google.com/forms/d/e/1FAIpQLScnHCm5eImjHVn6JQslb7eLWYE81YHPaVY1k9qJCreQesq5CQ/formResponse", {
      method: "POST",
      body: formData,
      mode: "no-cors"
    });
  };

  if (spinBtn) spinBtn.addEventListener('click', spin);

  /* AUTO HI·ªÜN POPUP */
  window.showPopup();
}

if (document.readyState === 'complete' || document.readyState === 'interactive') {
  qcadsBoot();
} else {
  document.addEventListener('DOMContentLoaded', qcadsBoot);
}
</script>

<!-- Script ch·ªëng copy trong popup (ES5-safe) -->
<script type="text/javascript">
  function qcadsHasPopupWidget(el) {
    while (el && el !== document) {
      if (el.className && typeof el.className === 'string' && el.className.indexOf('popup-widget') !== -1) return true;
      el = el.parentNode;
    }
    return false;
  }

  var qcadsPopup = document.querySelector('.popup-widget');

  document.addEventListener('contextmenu', function (e) {
    if (qcadsHasPopupWidget(e.target)) e.preventDefault();
  });

  document.addEventListener('keydown', function (e) {
    if (!qcadsHasPopupWidget(e.target)) return;

    var key = (e.key || '').toLowerCase();
    var isCtrl = !!e.ctrlKey;
    var forbidden = { u:1, s:1, c:1, x:1, i:1 };

    if ((isCtrl && forbidden[key]) || e.key === 'F12') e.preventDefault();
  });

  if (qcadsPopup) {
    qcadsPopup.style.userSelect = 'none';
    qcadsPopup.addEventListener('copy', function (e) { e.preventDefault(); });
    qcadsPopup.addEventListener('cut', function (e) { e.preventDefault(); });
  }
</script>
